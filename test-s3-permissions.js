"use strict";
// test-s3-permissions.ts
// Quick test to verify S3 permissions for backend API
Object.defineProperty(exports, "__esModule", { value: true });
const client_s3_1 = require("@aws-sdk/client-s3");
const s3_request_presigner_1 = require("@aws-sdk/s3-request-presigner");
const dotenv_1 = require("dotenv");
dotenv_1.default.config();
const s3 = new client_s3_1.S3Client({
    region: process.env.AWS_REGION || 'us-east-1',
    credentials: {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID,
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
    },
});
async function testPermissions() {
    var _a;
    console.log('üß™ Testing S3 Permissions for Backend API\n');
    console.log('Configuration:');
    console.log(`  Region: ${process.env.AWS_REGION}`);
    console.log(`  Original Bucket: ${process.env.S3_ORIGINAL_BUCKET}`);
    console.log(`  Transformed Bucket: ${process.env.S3_TRANSFORMED_BUCKET}`);
    console.log(`  Access Key: ${(_a = process.env.AWS_ACCESS_KEY_ID) === null || _a === void 0 ? void 0 : _a.substring(0, 8)}...`);
    console.log('');
    let passedTests = 0;
    let totalTests = 3;
    // Test 1: Generate presigned URL for original bucket upload
    try {
        const putCommand = new client_s3_1.PutObjectCommand({
            Bucket: process.env.S3_ORIGINAL_BUCKET,
            Key: 'test/permission-test.txt',
            ContentType: 'text/plain',
        });
        const uploadUrl = await (0, s3_request_presigner_1.getSignedUrl)(s3, putCommand, { expiresIn: 900 });
        console.log('‚úÖ Test 1: Can generate presigned URL for original bucket upload');
        console.log(`   URL: ${uploadUrl.substring(0, 80)}...`);
        passedTests++;
    }
    catch (error) {
        console.log('‚ùå Test 1: FAILED - Cannot generate presigned URL');
        console.log(`   Error: ${error.message}`);
        console.log(`   Code: ${error.Code}`);
    }
    console.log('');
    // Test 2: List original bucket (verify read access)
    try {
        const listResponse = await s3.send(new client_s3_1.ListObjectsV2Command({
            Bucket: process.env.S3_ORIGINAL_BUCKET,
            MaxKeys: 5,
        }));
        console.log('‚úÖ Test 2: Can list original bucket');
        console.log(`   Files found: ${listResponse.KeyCount || 0}`);
        passedTests++;
    }
    catch (error) {
        console.log('‚ùå Test 2: FAILED - Cannot list original bucket');
        console.log(`   Error: ${error.message}`);
        console.log(`   Code: ${error.Code}`);
    }
    console.log('');
    // Test 3: List transformed bucket (verify read access)
    try {
        const listResponse = await s3.send(new client_s3_1.ListObjectsV2Command({
            Bucket: process.env.S3_TRANSFORMED_BUCKET,
            MaxKeys: 5,
        }));
        console.log('‚úÖ Test 3: Can list transformed bucket');
        console.log(`   Files found: ${listResponse.KeyCount || 0}`);
        passedTests++;
    }
    catch (error) {
        console.log('‚ùå Test 3: FAILED - Cannot list transformed bucket');
        console.log(`   Error: ${error.message}`);
        console.log(`   Code: ${error.Code}`);
    }
    console.log('');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log(`Results: ${passedTests}/${totalTests} tests passed`);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('');
    if (passedTests === totalTests) {
        console.log('‚úÖ All permissions are working correctly!');
        console.log('   Your backend can:');
        console.log('   - Generate presigned URLs for uploads');
        console.log('   - Read/list original bucket');
        console.log('   - Read/list transformed bucket');
        console.log('');
        console.log('üëç You can proceed with running the backend API.');
    }
    else {
        console.log('‚ùå Some permissions are missing!');
        console.log('');
        console.log('Solutions:');
        console.log('  1. Check if AWS credentials in .env are correct');
        console.log('  2. Verify credentials have S3 permissions');
        console.log('  3. Deploy the BackendIamStack for dedicated IAM user');
        console.log('');
        console.log('Run: npx cdk deploy ImageOpt-BackendIAM');
    }
}
testPermissions().catch(console.error);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1zMy1wZXJtaXNzaW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRlc3QtczMtcGVybWlzc2lvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHlCQUF5QjtBQUN6QixzREFBc0Q7O0FBRXRELGtEQUFzRjtBQUN0Rix3RUFBNkQ7QUFDN0QsbUNBQTRCO0FBRTVCLGdCQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFFaEIsTUFBTSxFQUFFLEdBQUcsSUFBSSxvQkFBUSxDQUFDO0lBQ3RCLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxXQUFXO0lBQzdDLFdBQVcsRUFBRTtRQUNYLFdBQVcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFrQjtRQUMzQyxlQUFlLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBc0I7S0FDcEQ7Q0FDRixDQUFDLENBQUM7QUFFSCxLQUFLLFVBQVUsZUFBZTs7SUFDNUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0lBQzNELE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUM5QixPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0lBQ25ELE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO0lBQ3BFLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxDQUFDO0lBQzFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLE1BQUEsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsMENBQUUsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxF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QyxDQUFDO1FBQ2hCLE9BQU8sQ0FBQyxHQUFHLENBQUMseUNBQXlDLENBQUMsQ0FBQztJQUN6RCxDQUFDO0FBQ0gsQ0FBQztBQUVELGVBQWUsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0ZXN0LXMzLXBlcm1pc3Npb25zLnRzXHJcbi8vIFF1aWNrIHRlc3QgdG8gdmVyaWZ5IFMzIHBlcm1pc3Npb25zIGZvciBiYWNrZW5kIEFQSVxyXG5cclxuaW1wb3J0IHsgUzNDbGllbnQsIFB1dE9iamVjdENvbW1hbmQsIExpc3RPYmplY3RzVjJDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcclxuaW1wb3J0IHsgZ2V0U2lnbmVkVXJsIH0gZnJvbSAnQGF3cy1zZGsvczMtcmVxdWVzdC1wcmVzaWduZXInO1xyXG5pbXBvcnQgZG90ZW52IGZyb20gJ2RvdGVudic7XHJcblxyXG5kb3RlbnYuY29uZmlnKCk7XHJcblxyXG5jb25zdCBzMyA9IG5ldyBTM0NsaWVudCh7XHJcbiAgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICd1cy1lYXN0LTEnLFxyXG4gIGNyZWRlbnRpYWxzOiB7XHJcbiAgICBhY2Nlc3NLZXlJZDogcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQhLFxyXG4gICAgc2VjcmV0QWNjZXNzS2V5OiBwcm9jZXNzLmVudi5BV1NfU0VDUkVUX0FDQ0VTU19LRVkhLFxyXG4gIH0sXHJcbn0pO1xyXG5cclxuYXN5bmMgZnVuY3Rpb24gdGVzdFBlcm1pc3Npb25zKCkge1xyXG4gIGNvbnNvbGUubG9nKCfwn6eqIFRlc3RpbmcgUzMgUGVybWlzc2lvbnMgZm9yIEJhY2tlbmQgQVBJXFxuJyk7XHJcbiAgY29uc29sZS5sb2coJ0NvbmZpZ3VyYXRpb246Jyk7XHJcbiAgY29uc29sZS5sb2coYCAgUmVnaW9uOiAke3Byb2Nlc3MuZW52LkFXU19SRUdJT059YCk7XHJcbiAgY29uc29sZS5sb2coYCAgT3JpZ2luYWwgQnVja2V0OiAke3Byb2Nlc3MuZW52LlMzX09SSUdJTkFMX0JVQ0tFVH1gKTtcclxuICBjb25zb2xlLmxvZyhgICBUcmFuc2Zvcm1lZCBCdWNrZXQ6ICR7cHJvY2Vzcy5lbnYuUzNfVFJBTlNGT1JNRURfQlVDS0VUfWApO1xyXG4gIGNvbnNvbGUubG9nKGAgIEFjY2VzcyBLZXk6ICR7cHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQ/LnN1YnN0cmluZygwLCA4KX0uLi5gKTtcclxuICBjb25zb2xlLmxvZygnJyk7XHJcblxyXG4gIGxldCBwYXNzZWRUZXN0cyA9IDA7XHJcbiAgbGV0IHRvdGFsVGVzdHMgPSAzO1xyXG5cclxuICAvLyBUZXN0IDE6IEdlbmVyYXRlIHByZXNpZ25lZCBVUkwgZm9yIG9yaWdpbmFsIGJ1Y2tldCB1cGxvYWRcclxuICB0cnkge1xyXG4gICAgY29uc3QgcHV0Q29tbWFuZCA9IG5ldyBQdXRPYmplY3RDb21tYW5kKHtcclxuICAgICAgQnVja2V0OiBwcm9jZXNzLmVudi5TM19PUklHSU5BTF9CVUNLRVQsXHJcbiAgICAgIEtleTogJ3Rlc3QvcGVybWlzc2lvbi10ZXN0LnR4dCcsXHJcbiAgICAgIENvbnRlbnRUeXBlOiAndGV4dC9wbGFpbicsXHJcbiAgICB9KTtcclxuICAgIGNvbnN0IHVwbG9hZFVybCA9IGF3YWl0IGdldFNpZ25lZFVybChzMywgcHV0Q29tbWFuZCwgeyBleHBpcmVzSW46IDkwMCB9KTtcclxuICAgIGNvbnNvbGUubG9nKCfinIUgVGVzdCAxOiBDYW4gZ2VuZXJhdGUgcHJlc2lnbmVkIFVSTCBmb3Igb3JpZ2luYWwgYnVja2V0IHVwbG9hZCcpO1xyXG4gICAgY29uc29sZS5sb2coYCAgIFVSTDogJHt1cGxvYWRVcmwuc3Vic3RyaW5nKDAsIDgwKX0uLi5gKTtcclxuICAgIHBhc3NlZFRlc3RzKys7XHJcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgY29uc29sZS5sb2coJ+KdjCBUZXN0IDE6IEZBSUxFRCAtIENhbm5vdCBnZW5lcmF0ZSBwcmVzaWduZWQgVVJMJyk7XHJcbiAgICBjb25zb2xlLmxvZyhgICAgRXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1gKTtcclxuICAgIGNvbnNvbGUubG9nKGAgICBDb2RlOiAke2Vycm9yLkNvZGV9YCk7XHJcbiAgfVxyXG5cclxuICBjb25zb2xlLmxvZygnJyk7XHJcblxyXG4gIC8vIFRlc3QgMjogTGlzdCBvcmlnaW5hbCBidWNrZXQgKHZlcmlmeSByZWFkIGFjY2VzcylcclxuICB0cnkge1xyXG4gICAgY29uc3QgbGlzdFJlc3BvbnNlID0gYXdhaXQgczMuc2VuZChuZXcgTGlzdE9iamVjdHNWMkNvbW1hbmQoe1xyXG4gICAgICBCdWNrZXQ6IHByb2Nlc3MuZW52LlMzX09SSUdJTkFMX0JVQ0tFVCxcclxuICAgICAgTWF4S2V5czogNSxcclxuICAgIH0pKTtcclxuICAgIGNvbnNvbGUubG9nKCfinIUgVGVzdCAyOiBDYW4gbGlzdCBvcmlnaW5hbCBidWNrZXQnKTtcclxuICAgIGNvbnNvbGUubG9nKGAgICBGaWxlcyBmb3VuZDogJHtsaXN0UmVzcG9uc2UuS2V5Q291bnQgfHwgMH1gKTtcclxuICAgIHBhc3NlZFRlc3RzKys7XHJcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgY29uc29sZS5sb2coJ+KdjCBUZXN0IDI6IEZBSUxFRCAtIENhbm5vdCBsaXN0IG9yaWdpbmFsIGJ1Y2tldCcpO1xyXG4gICAgY29uc29sZS5sb2coYCAgIEVycm9yOiAke2Vycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICBjb25zb2xlLmxvZyhgICAgQ29kZTogJHtlcnJvci5Db2RlfWApO1xyXG4gIH1cclxuXHJcbiAgY29uc29sZS5sb2coJycpO1xyXG5cclxuICAvLyBUZXN0IDM6IExpc3QgdHJhbnNmb3JtZWQgYnVja2V0ICh2ZXJpZnkgcmVhZCBhY2Nlc3MpXHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IGxpc3RSZXNwb25zZSA9IGF3YWl0IHMzLnNlbmQobmV3IExpc3RPYmplY3RzVjJDb21tYW5kKHtcclxuICAgICAgQnVja2V0OiBwcm9jZXNzLmVudi5TM19UUkFOU0ZPUk1FRF9CVUNLRVQsXHJcbiAgICAgIE1heEtleXM6IDUsXHJcbiAgICB9KSk7XHJcbiAgIGNvbnNvbGUubG9nKCfinIUgVGVzdCAzOiBDYW4gbGlzdCB0cmFuc2Zvcm1lZCBidWNrZXQnKTtcclxuICAgIGNvbnNvbGUubG9nKGAgICBGaWxlcyBmb3VuZDogJHtsaXN0UmVzcG9uc2UuS2V5Q291bnQgfHwgMH1gKTtcclxuICAgIHBhc3NlZFRlc3RzKys7XHJcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgY29uc29sZS5sb2coJ+KdjCBUZXN0IDM6IEZBSUxFRCAtIENhbm5vdCBsaXN0IHRyYW5zZm9ybWVkIGJ1Y2tldCcpO1xyXG4gICAgY29uc29sZS5sb2coYCAgIEVycm9yOiAke2Vycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICBjb25zb2xlLmxvZyhgICAgQ29kZTogJHtlcnJvci5Db2RlfWApO1xyXG4gIH1cclxuXHJcbiAgY29uc29sZS5sb2coJycpO1xyXG4gIGNvbnNvbGUubG9nKCfilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAnKTtcclxuICBjb25zb2xlLmxvZyhgUmVzdWx0czogJHtwYXNzZWRUZXN0c30vJHt0b3RhbFRlc3RzfSB0ZXN0cyBwYXNzZWRgKTtcclxuICBjb25zb2xlLmxvZygn4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQJyk7XHJcbiAgY29uc29sZS5sb2coJycpO1xyXG5cclxuICBpZiAocGFzc2VkVGVzdHMgPT09IHRvdGFsVGVzdHMpIHtcclxuICAgIGNvbnNvbGUubG9nKCfinIUgQWxsIHBlcm1pc3Npb25zIGFyZSB3b3JraW5nIGNvcnJlY3RseSEnKTtcclxuICAgIGNvbnNvbGUubG9nKCcgICBZb3VyIGJhY2tlbmQgY2FuOicpO1xyXG4gICAgY29uc29sZS5sb2coJyAgIC0gR2VuZXJhdGUgcHJlc2lnbmVkIFVSTHMgZm9yIHVwbG9hZHMnKTtcclxuICAgIGNvbnNvbGUubG9nKCcgICAtIFJlYWQvbGlzdCBvcmlnaW5hbCBidWNrZXQnKTtcclxuICAgIGNvbnNvbGUubG9nKCcgICAtIFJlYWQvbGlzdCB0cmFuc2Zvcm1lZCBidWNrZXQnKTtcclxuICAgIGNvbnNvbGUubG9nKCcnKTtcclxuICAgIGNvbnNvbGUubG9nKCfwn5GNIFlvdSBjYW4gcHJvY2VlZCB3aXRoIHJ1bm5pbmcgdGhlIGJhY2tlbmQgQVBJLicpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBjb25zb2xlLmxvZygn4p2MIFNvbWUgcGVybWlzc2lvbnMgYXJlIG1pc3NpbmchJyk7XHJcbiAgICBjb25zb2xlLmxvZygnJyk7XHJcbiAgICBjb25zb2xlLmxvZygnU29sdXRpb25zOicpO1xyXG4gICAgY29uc29sZS5sb2coJyAgMS4gQ2hlY2sgaWYgQVdTIGNyZWRlbnRpYWxzIGluIC5lbnYgYXJlIGNvcnJlY3QnKTtcclxuICAgIGNvbnNvbGUubG9nKCcgIDIuIFZlcmlmeSBjcmVkZW50aWFscyBoYXZlIFMzIHBlcm1pc3Npb25zJyk7XHJcbiAgICBjb25zb2xlLmxvZygnICAzLiBEZXBsb3kgdGhlIEJhY2tlbmRJYW1TdGFjayBmb3IgZGVkaWNhdGVkIElBTSB1c2VyJyk7XHJcbiAgICBjb25zb2xlLmxvZygnJyk7XHJcbiAgICBjb25zb2xlLmxvZygnUnVuOiBucHggY2RrIGRlcGxveSBJbWFnZU9wdC1CYWNrZW5kSUFNJyk7XHJcbiAgfVxyXG59XHJcblxyXG50ZXN0UGVybWlzc2lvbnMoKS5jYXRjaChjb25zb2xlLmVycm9yKTtcclxuIl19