"use strict";
// assets/asset.service.ts
// Asset business logic
Object.defineProperty(exports, "__esModule", { value: true });
exports.AssetService = void 0;
const mongoose_1 = require("mongoose");
const asset_model_1 = require("./asset.model");
const asset_log_model_1 = require("./asset-log.model");
class AssetService {
    /**
     * Create new asset
     */
    async create(ownerId, name, type, s3Bucket, s3Key, cloudfrontUrl, sizeBytes, metadata) {
        const asset = new asset_model_1.Asset({
            ownerId: new mongoose_1.default.Types.ObjectId(ownerId),
            name,
            type,
            s3Bucket,
            s3Key,
            cloudfrontUrl,
            sizeBytes,
            metadata,
        });
        return asset.save();
    }
    /**
     * Get user's assets (excluding deleted)
     */
    async getUserAssets(ownerId, page = 1, limit = 20) {
        return asset_model_1.Asset.find({ ownerId, isDeleted: false })
            .sort({ createdAt: -1 })
            .skip((page - 1) * limit)
            .limit(limit);
    }
    /**
     * Get single asset by ID
     */
    async getById(assetId, ownerId) {
        const query = { _id: assetId, isDeleted: false };
        if (ownerId) {
            query.ownerId = ownerId;
        }
        return asset_model_1.Asset.findOne(query);
    }
    /**
     * Get asset by S3 key
     */
    async getByS3Key(s3Key) {
        return asset_model_1.Asset.findOne({ s3Key, isDeleted: false });
    }
    /**
     * Soft delete asset
     */
    async softDelete(assetId, ownerId) {
        const result = await asset_model_1.Asset.updateOne({ _id: assetId, ownerId }, { $set: { isDeleted: true } });
        return result.modifiedCount > 0;
    }
    /**
     * Restore soft-deleted asset
     */
    async restore(assetId, ownerId) {
        const result = await asset_model_1.Asset.updateOne({ _id: assetId, ownerId, isDeleted: true }, { $set: { isDeleted: false } });
        return result.modifiedCount > 0;
    }
    /**
     * Get bandwidth usage for an asset
     */
    async getAssetBandwidthStats(assetId) {
        const objectId = new mongoose_1.default.Types.ObjectId(assetId);
        const stats = await asset_log_model_1.AssetLog.aggregate([
            { $match: { assetId: objectId } },
            {
                $group: {
                    _id: null,
                    totalBytes: { $sum: '$bytes' },
                    totalRequests: { $sum: 1 },
                    hits: {
                        $sum: { $cond: [{ $eq: ['$edgeResult', 'Hit'] }, 1, 0] },
                    },
                },
            },
        ]);
        if (stats.length === 0) {
            return { totalBytes: 0, totalRequests: 0, hitRatio: 0 };
        }
        const { totalBytes, totalRequests, hits } = stats[0];
        const hitRatio = totalRequests > 0 ? (hits / totalRequests) * 100 : 0;
        return { totalBytes, totalRequests, hitRatio };
    }
    /**
     * Count user's assets
     */
    async countUserAssets(ownerId) {
        return asset_model_1.Asset.countDocuments({ ownerId, isDeleted: false });
    }
}
exports.AssetService = AssetService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFzc2V0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDBCQUEwQjtBQUMxQix1QkFBdUI7OztBQUV2Qix1Q0FBZ0M7QUFDaEMsK0NBQThDO0FBQzlDLHVEQUE2QztBQUU3QyxNQUFhLFlBQVk7SUFDdkI7O09BRUc7SUFDSCxLQUFLLENBQUMsTUFBTSxDQUNWLE9BQWUsRUFDZixJQUFZLEVBQ1osSUFBZ0MsRUFDaEMsUUFBZ0IsRUFDaEIsS0FBYSxFQUNiLGFBQXFCLEVBQ3JCLFNBQWlCLEVBQ2pCLFFBQStEO1FBRS9ELE1BQU0sS0FBSyxHQUFHLElBQUksbUJBQUssQ0FBQztZQUN0QixPQUFPLEVBQUUsSUFBSSxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO1lBQzdDLElBQUk7WUFDSixJQUFJO1lBQ0osUUFBUTtZQUNSLEtBQUs7WUFDTCxhQUFhO1lBQ2IsU0FBUztZQUNULFFBQVE7U0FDVCxDQUFDLENBQUM7UUFFSCxPQUFPLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN0QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsYUFBYSxDQUFDLE9BQWUsRUFBRSxPQUFlLENBQUMsRUFBRSxRQUFnQixFQUFFO1FBQ3ZFLE9BQU8sbUJBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDO2FBQzdDLElBQUksQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDO2FBQ3ZCLElBQUksQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUM7YUFDeEIsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBZSxFQUFFLE9BQWdCO1FBQzdDLE1BQU0s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RUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUM3RCxDQUFDO0NBQ0Y7QUF0SEQsb0NBc0hDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gYXNzZXRzL2Fzc2V0LnNlcnZpY2UudHNcclxuLy8gQXNzZXQgYnVzaW5lc3MgbG9naWNcclxuXHJcbmltcG9ydCBtb25nb29zZSBmcm9tICdtb25nb29zZSc7XHJcbmltcG9ydCB7IEFzc2V0LCBJQXNzZXQgfSBmcm9tICcuL2Fzc2V0Lm1vZGVsJztcclxuaW1wb3J0IHsgQXNzZXRMb2cgfSBmcm9tICcuL2Fzc2V0LWxvZy5tb2RlbCc7XHJcblxyXG5leHBvcnQgY2xhc3MgQXNzZXRTZXJ2aWNlIHtcclxuICAvKipcclxuICAgKiBDcmVhdGUgbmV3IGFzc2V0XHJcbiAgICovXHJcbiAgYXN5bmMgY3JlYXRlKFxyXG4gICAgb3duZXJJZDogc3RyaW5nLFxyXG4gICAgbmFtZTogc3RyaW5nLFxyXG4gICAgdHlwZTogJ2ltYWdlJyB8ICd2aWRlbycgfCAnZmlsZScsXHJcbiAgICBzM0J1Y2tldDogc3RyaW5nLFxyXG4gICAgczNLZXk6IHN0cmluZyxcclxuICAgIGNsb3VkZnJvbnRVcmw6IHN0cmluZyxcclxuICAgIHNpemVCeXRlczogbnVtYmVyLFxyXG4gICAgbWV0YWRhdGE/OiB7IHdpZHRoPzogbnVtYmVyOyBoZWlnaHQ/OiBudW1iZXI7IGZvcm1hdD86IHN0cmluZyB9XHJcbiAgKTogUHJvbWlzZTxJQXNzZXQ+IHtcclxuICAgIGNvbnN0IGFzc2V0ID0gbmV3IEFzc2V0KHtcclxuICAgICAgb3duZXJJZDogbmV3IG1vbmdvb3NlLlR5cGVzLk9iamVjdElkKG93bmVySWQpLFxyXG4gICAgICBuYW1lLFxyXG4gICAgICB0eXBlLFxyXG4gICAgICBzM0J1Y2tldCxcclxuICAgICAgczNLZXksXHJcbiAgICAgIGNsb3VkZnJvbnRVcmwsXHJcbiAgICAgIHNpemVCeXRlcyxcclxuICAgICAgbWV0YWRhdGEsXHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gYXNzZXQuc2F2ZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHVzZXIncyBhc3NldHMgKGV4Y2x1ZGluZyBkZWxldGVkKVxyXG4gICAqL1xyXG4gIGFzeW5jIGdldFVzZXJBc3NldHMob3duZXJJZDogc3RyaW5nLCBwYWdlOiBudW1iZXIgPSAxLCBsaW1pdDogbnVtYmVyID0gMjApOiBQcm9taXNlPElBc3NldFtdPiB7XHJcbiAgICByZXR1cm4gQXNzZXQuZmluZCh7IG93bmVySWQsIGlzRGVsZXRlZDogZmFsc2UgfSlcclxuICAgICAgLnNvcnQoeyBjcmVhdGVkQXQ6IC0xIH0pXHJcbiAgICAgIC5za2lwKChwYWdlIC0gMSkgKiBsaW1pdClcclxuICAgICAgLmxpbWl0KGxpbWl0KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBzaW5nbGUgYXNzZXQgYnkgSURcclxuICAgKi9cclxuICBhc3luYyBnZXRCeUlkKGFzc2V0SWQ6IHN0cmluZywgb3duZXJJZD86IHN0cmluZyk6IFByb21pc2U8SUFzc2V0IHwgbnVsbD4ge1xyXG4gICAgY29uc3QgcXVlcnk6IGFueSA9IHsgX2lkOiBhc3NldElkLCBpc0RlbGV0ZWQ6IGZhbHNlIH07XHJcbiAgICBpZiAob3duZXJJZCkge1xyXG4gICAgICBxdWVyeS5vd25lcklkID0gb3duZXJJZDtcclxuICAgIH1cclxuICAgIHJldHVybiBBc3NldC5maW5kT25lKHF1ZXJ5KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBhc3NldCBieSBTMyBrZXlcclxuICAgKi9cclxuICBhc3luYyBnZXRCeVMzS2V5KHMzS2V5OiBzdHJpbmcpOiBQcm9taXNlPElBc3NldCB8IG51bGw+IHtcclxuICAgIHJldHVybiBBc3NldC5maW5kT25lKHsgczNLZXksIGlzRGVsZXRlZDogZmFsc2UgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTb2Z0IGRlbGV0ZSBhc3NldFxyXG4gICAqL1xyXG4gIGFzeW5jIHNvZnREZWxldGUoYXNzZXRJZDogc3RyaW5nLCBvd25lcklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IEFzc2V0LnVwZGF0ZU9uZShcclxuICAgICAgeyBfaWQ6IGFzc2V0SWQsIG93bmVySWQgfSxcclxuICAgICAgeyAkc2V0OiB7IGlzRGVsZXRlZDogdHJ1ZSB9IH1cclxuICAgICk7XHJcbiAgICByZXR1cm4gcmVzdWx0Lm1vZGlmaWVkQ291bnQgPiAwO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdG9yZSBzb2Z0LWRlbGV0ZWQgYXNzZXRcclxuICAgKi9cclxuICBhc3luYyByZXN0b3JlKGFzc2V0SWQ6IHN0cmluZywgb3duZXJJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBBc3NldC51cGRhdGVPbmUoXHJcbiAgICAgIHsgX2lkOiBhc3NldElkLCBvd25lcklkLCBpc0RlbGV0ZWQ6IHRydWUgfSxcclxuICAgICAgeyAkc2V0OiB7IGlzRGVsZXRlZDogZmFsc2UgfSB9XHJcbiAgICApO1xyXG4gICAgcmV0dXJuIHJlc3VsdC5tb2RpZmllZENvdW50ID4gMDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBiYW5kd2lkdGggdXNhZ2UgZm9yIGFuIGFzc2V0XHJcbiAgICovXHJcbiAgYXN5bmMgZ2V0QXNzZXRCYW5kd2lkdGhTdGF0cyhhc3NldElkOiBzdHJpbmcpOiBQcm9taXNlPHtcclxuICAgIHRvdGFsQnl0ZXM6IG51bWJlcjtcclxuICAgIHRvdGFsUmVxdWVzdHM6IG51bWJlcjtcclxuICAgIGhpdFJhdGlvOiBudW1iZXI7XHJcbiAgfT4ge1xyXG4gICAgY29uc3Qgb2JqZWN0SWQgPSBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQoYXNzZXRJZCk7XHJcbiAgICBcclxuICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgQXNzZXRMb2cuYWdncmVnYXRlKFtcclxuICAgICAgeyAkbWF0Y2g6IHsgYXNzZXRJZDogb2JqZWN0SWQgfSB9LFxyXG4gICAgICB7XHJcbiAgICAgICAgJGdyb3VwOiB7XHJcbiAgICAgICAgICBfaWQ6IG51bGwsXHJcbiAgICAgICAgICB0b3RhbEJ5dGVzOiB7ICRzdW06ICckYnl0ZXMnIH0sXHJcbiAgICAgICAgICB0b3RhbFJlcXVlc3RzOiB7ICRzdW06IDEgfSxcclxuICAgICAgICAgIGhpdHM6IHtcclxuICAgICAgICAgICAgJHN1bTogeyAkY29uZDogW3sgJGVxOiBbJyRlZGdlUmVzdWx0JywgJ0hpdCddIH0sIDEsIDBdIH0sXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH0sXHJcbiAgICBdKTtcclxuXHJcbiAgICBpZiAoc3RhdHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiB7IHRvdGFsQnl0ZXM6IDAsIHRvdGFsUmVxdWVzdHM6IDAsIGhpdFJhdGlvOiAwIH07XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgeyB0b3RhbEJ5dGVzLCB0b3RhbFJlcXVlc3RzLCBoaXRzIH0gPSBzdGF0c1swXTtcclxuICAgIGNvbnN0IGhpdFJhdGlvID0gdG90YWxSZXF1ZXN0cyA+IDAgPyAoaGl0cyAvIHRvdGFsUmVxdWVzdHMpICogMTAwIDogMDtcclxuXHJcbiAgICByZXR1cm4geyB0b3RhbEJ5dGVzLCB0b3RhbFJlcXVlc3RzLCBoaXRSYXRpbyB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ291bnQgdXNlcidzIGFzc2V0c1xyXG4gICAqL1xyXG4gIGFzeW5jIGNvdW50VXNlckFzc2V0cyhvd25lcklkOiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcj4ge1xyXG4gICAgcmV0dXJuIEFzc2V0LmNvdW50RG9jdW1lbnRzKHsgb3duZXJJZCwgaXNEZWxldGVkOiBmYWxzZSB9KTtcclxuICB9XHJcbn1cclxuIl19